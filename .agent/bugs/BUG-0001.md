---
id: BUG-0001
title: Purchase item display inconsistent across Trip, Inventory, and Budget views
severity: high
status: fixed
reported: 2026-02-09
fixed: 2026-02-09
affected_views:
  - TripDetailContent (Calendar > Trip Manager)
  - TripReceiptList (Inventory > Purchases sheet)
  - PurchaseList (Budget > BudgetDayDetail expanded trip)
  - BudgetDayDetail (Budget > click on day total)
---

# BUG-0001: Purchase item display inconsistent across Trip, Inventory, and Budget views

## Summary

The same purchase (e.g., "2 Gordon's Boneless Skinless Chicken Breast of 40 lb") displays differently across four views in the app. The Trip Manager view (via Calendar) shows the correct, fully-formatted "unified item phrase" with store code and price-per-qty. Other views show truncated, missing, or differently-formatted data for the same purchase — causing user confusion about whether the data is even accurate.

## Steps to Reproduce

1. Create a trip with at least one purchase (e.g., 2x Gordon's Boneless Skinless Chicken Breast, 40 lb, $139.98 total, store code 7103770, $69.99/qty)
2. **SC1 — Trip Manager**: Calendar > Week View > click the trip task > "Manage Trip" > see the purchase in the stop's PurchaseList
3. **SC2 — Inventory Purchases**: Inventory > Purchases sheet > expand the trip receipt > see the same purchase in TripReceiptList
4. **SC3 — Budget "Total Spent"**: Budget > click on the total spent amount in a day cell > BudgetDayDetail opens
5. **SC4 — Budget Trip Expansion**: In BudgetDayDetail > click on the trip expense entry to expand > see purchase list

## Expected Behavior

All four views should display the purchase identically, using the `BaseItemEntry` component with the unified item phrase format: **"2 Gordon's Boneless Skinless Chicken Breast of 40 lb"** with subtitle line showing store code `7103770` and `$69.99/qty`.

## Actual Behavior

| View | What's Shown | Issues |
|------|-------------|--------|
| **SC1** — Trip Manager (PurchaseList) | `2 Gordon's Boneless Skinless Chicken Breast of 40 lb` / `7103770  $69.99/qty` / `$139.98` | ✅ **Correct** — this is the canonical format |
| **SC2** — Inventory > Purchases (TripReceiptList) | `2 Gordon's Boneless Skinless Chicken Breast of 20 lb` / `Gordon Food Service Store  7103770  $69.99/qty` | ❌ Shows **"20 lb" instead of "40 lb"** — likely a field mapping issue (`item.quantity` vs `purchase.units`). Also shows store name inline (acceptable but differs from SC1). |
| **SC3** — Budget Day Detail (entry row) | `Gordon Food Service Store` / `2 @ 69.99 4-10# BNLS SKNLS C 7103770` / `-$139.98` | ❌ Doesn't use `BaseItemEntry` at all. Shows raw receipt text. Edit and delete icons appear but the format is completely different. |
| **SC4** — Budget Day Detail (expanded trip purchases) | Uses `BaseItemEntry` but the **list overflows** and isn't scrollable (see BUG-0002) | ❌ Display format is correct when visible, but the list is unusable |

## Screenshots

| Label | Description |
|-------|-------------|
| SC1 | Trip Manager > Purchases list — correct unified item phrase with store code and price breakdown |
| SC2 | Inventory > Purchases sheet > expanded trip receipt — shows "20 lb" instead of "40 lb", includes store name |
| SC3 | Budget > Day Detail > expense entry row — raw receipt text format, no BaseItemEntry |
| SC4 | Budget > Day Detail > expanded trip > purchase list — items render via BaseItemEntry but list overflows |

## Affected Components

| Component | File Path | Role |
|-----------|-----------|------|
| `PurchaseList` | `client/src/components/budget/PurchaseList.vue` | Renders purchases in Trip Manager — **canonical/correct format** |
| `TripReceiptList` | `client/src/components/inventory/TripReceiptList.vue` | Renders purchases in Inventory > Purchases sheet — field mapping issue |
| `BudgetDayDetail` | `client/src/components/budget/BudgetDayDetail.vue` | Budget popout: expense entry rows use custom HTML (not BaseItemEntry); expanded trip purchases use BaseItemEntry |
| `BaseItemEntry` | `client/src/components/shared/BaseItemEntry.vue` | Shared component for unified item display — the standard |
| `TripDetailContent` | `client/src/components/calendar/TripDetailContent.vue` | Trip Manager wrapper — uses `PurchaseList` (correct) |

## Root Cause Analysis

### Discrepancy 1: TripReceiptList shows "20 lb" instead of "40 lb"
The `TripReceiptList` passes `item.quantity` → `:units` prop. The `item.quantity` from the `InventoryItem` / `TripReceipt` data shape may represent a **per-unit quantity** (20 lb per item) rather than the total (40 lb for 2 items). The `PurchaseList` uses `purchase.units` which is the correct total. This is a **data shape mismatch** between the `TripReceipt.items[]` shape and the `Purchase` shape.

### Discrepancy 2: Budget expense entry doesn't use BaseItemEntry
The `BudgetDayDetail` expense entry rows (lines 233–304) use inline custom HTML to display `entry.source?.name` and amount. For trip entries, this shows the store name and total — but when expanded, the individual purchases render via `BaseItemEntry`. The **main entry row** should also show the items in BaseItemEntry format, or at minimum the store-level summary should not show raw receipt text.

### Discrepancy 3: Budget expense entry showing raw receipt text
The `2 @ 69.99 4-10# BNLS SKNLS C 7103770` appears to be raw receipt line text from the `notes` or `description` field of the budget entry, rather than structured purchase data.

## Fix Strategy

### Fix 1: TripReceiptList field mapping
- Investigate the `TripReceipt` → `items[]` data shape. Confirm whether `item.quantity` is per-unit or total.
- If per-unit: compute `item.quantity * item.count` for the `:units` prop
- If the backend returns it differently: fix the backend serializer to include `units` as total weight/volume

### Fix 2: Budget expense entry format
- **Option A** (Recommended): Replace the custom expense entry HTML in `BudgetDayDetail.vue` (lines 238–303) with `BaseItemEntry` for trip entries, matching the Trip Manager's display
- **Option B**: Keep the store-level summary row but format it properly (store name + item count + total), not raw receipt text

### Fix 3: Ensure `BaseItemEntry` props are identical across all callers
Audit all callers of `BaseItemEntry` and create a shared mapping function or composable:
```typescript
// Proposed: utils/purchaseToBaseItemProps.ts
export function purchaseToBaseItemProps(purchase: Purchase) {
  return {
    name: purchase.item,
    brand: purchase.brand,
    count: purchase.count,
    countUnit: purchase.count_unit,
    units: purchase.units,
    unitMeasurement: purchase.unit_measurement,
    storeCode: purchase.store_code,
    total: purchase.total_price,
    pricePerCount: purchase.price_per_count,
    pricePerUnit: purchase.price_per_unit,
    taxable: purchase.taxable,
    tags: purchase.tags
  }
}
```

### Relevant Skills & Workflows
- **Skill**: `common-problems` — Category 1 (BaseItemEntry Prop Mapping) documents exactly this class of bug
- **Skill**: `bug-noting` — Used to file this bug
- **KI**: `GUI Design System and Implementation Standards` — documents the unified item phrase standard and `formatItemCell` utility
- **KI**: `Financial Logistics and Budget Management` — documents purchase data shapes and serialization

### Common Problems to Check
- See `.agent/skills/common-problems/SKILL.md` Category 1: BaseItemEntry Prop Mapping
- See `.agent/skills/common-problems/SKILL.md` Category 5: Data Shape Mismatches

## Linked Bugs
- Related: BUG-0002 (budget day detail scroll issue — same view, different problem)

## Resolution

**Fixed 2026-02-09** — Four changes applied:

1. **`TripReceiptList.vue`**: Added `getTotalUnits(item)` that computes `quantity × count` to reconstruct total weight/volume. Changed `:units` binding from `item.quantity` to `getTotalUnits(item)`.
2. **`budget_entry_controller.ex`**: Added `store_code`, `unit_measurement`, `taxable`, `tax_rate`, and `tags` to `purchase_to_json`.
3. **`budget.ex`**: Updated preload chain to include `purchase: [:tags, stop: [:store, purchases: :tags]]`.
4. **`BudgetDayDetail.vue`**: Added `:price-per-count` and `:price-per-unit` props to expanded purchase BaseItemEntry.

**Skill created**: `.agent/skills/fix-item-display-consistency/SKILL.md`
